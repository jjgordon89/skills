---
description: 保存出院小结信息
arguments:
  - name: source
    description: 出院小结来源（图片路径或文字描述）
    required: true
  - name: admission_date
    description: 入院日期（格式：YYYY-MM-DD，可选）
    required: false
  - name: discharge_date
    description: 出院日期（格式：YYYY-MM-DD，可选）
    required: false
---

# 出院小结管理

用于保存和结构化出院小结信息，支持从图片提取或直接从文字描述处理。

## 参数说明

- `source`（必填）：出院小结来源，可以是：
  - 图片路径：`@医疗报告/出院小结.jpg`
  - 文字描述：直接粘贴出院小结的文本内容或摘要

- `admission_date`（可选）：入院日期，格式 YYYY-MM-DD
- `discharge_date`（可选）：出院日期，格式 YYYY-MM-DD

## 执行步骤

### 情况1：从图片提取

如果用户提供了图片路径：

1. **读取并分析图片**
   - 使用 Read 工具读取出院小结图片
   - 使用 mcp__4_5v_mcp__analyze_image 工具分析图片内容

   **图片分析提示词模板：**
   ```
   请详细识别这张出院小结的所有内容，包括：

   1. **基础信息：**
      - 患者姓名
      - 性别、年龄
      - 入院日期、出院日期
      - 住院天数
      - 住院科室、床号
      - 医保类型

   2. **诊断信息：**
      - 入院诊断（主要诊断和其他诊断）
      - 出院诊断（主要诊断和其他诊断）
      - 诊断编码（ICD-10，如有）

   3. **治疗经过：**
      - 主要治疗措施
      - 手术记录（如有）
      - 药物治疗方案
      - 检查结果摘要

   4. **出院情况：**
      - 出院时病情状态
      - 症状改善情况
      - 生命体征

   5. **出院医嘱：**
      - 用药指导（药品名称、剂量、用法、疗程）
      - 饮食指导
      - 活动指导
      - 伤口护理（如有）
      - 复查计划和时间
      - 注意事项

   6. **其他信息：**
      - 主治医生
      - 医院名称
      - 住院费用（如有）
      - 随诊电话

   请以结构化的方式列出所有信息，保持原文准确性。
   ```

2. **提取并结构化数据**
   - 从图片识别结果中提取所有关键字段
   - 组织成结构化 JSON 格式

### 情况2：从文字描述处理

如果用户直接提供文字内容：

1. **分析文本内容**
   - 从用户提供的文字中提取信息
   - 按照下方数据结构进行分类

2. **询问缺失信息**
   - 如果关键信息缺失，询问用户补充

### 2. 生成数据文件

**文件路径格式：**
`data/出院小结/YYYY-MM/YYYY-MM-DD_主要诊断.json`

**JSON 数据结构：**
```json
{
  "id": "{{生成唯一ID，使用日期+时间戳}}",
  "basic_info": {
    "hospital": "某某医院",
    "department": "消化内科",
    "admission_date": "2024-08-10",
    "discharge_date": "2024-08-15",
    "hospitalization_days": 5,
    "bed_number": "23床",
    "insurance_type": "职工医保"
  },
  "diagnosis": {
    "admission_diagnosis": {
      "main": "急性胆囊炎",
      "secondary": [
        "胆囊结石",
        "高血压病（2级，中危组）"
      ],
      "icd_codes": {
        "main": "K80.0",
        "secondary": ["I10"]
      }
    },
    "discharge_diagnosis": {
      "main": "急性胆囊炎",
      "secondary": [
        "胆囊结石",
        "高血压病（2级，中危组）",
        "2型糖尿病"
      ],
      "icd_codes": {
        "main": "K80.0",
        "secondary": ["I10", "E11.9"]
      }
    }
  },
  "treatment_summary": {
    "main_treatments": [
      "禁食水、胃肠减压",
      "抗感染治疗（头孢哌酮钠舒巴坦钠）",
      "解痉止痛治疗",
      "补液支持治疗"
    ],
    "medications": [
      {
        "drug_name": "头孢哌酮钠舒巴坦钠",
        "dosage": "2.0g",
        "frequency": "每12小时一次",
        "route": "静脉滴注",
        "duration": "5天"
      },
      {
        "drug_name": "阿托品",
        "dosage": "0.5mg",
        "frequency": "必要时",
        "route": "肌肉注射"
      }
    ],
    "procedures": [],
    "surgeries": [
      {
        "surgery_name": "腹腔镜下胆囊切除术",
        "surgery_date": "2024-08-12",
        "anesthesia": "全身麻醉",
        "surgeon": "张医生"
      }
    ],
    "examination_results": "血常规：WBC 12.5×10^9/L，N% 85%；腹部B超：胆囊壁增厚，胆囊结石"
  },
  "discharge_status": {
    "condition": "好转",
    "symptoms": "腹痛缓解，无发热，饮食恢复",
    "vital_signs": {
      "blood_pressure": "130/80 mmHg",
      "heart_rate": "78 次/分",
      "temperature": "36.5℃",
      "respiration": "18 次/分"
    },
    "activity_level": "可下床活动"
  },
  "discharge_orders": {
    "medication_instructions": [
      {
        "drug_name": "阿莫西林胶囊",
        "dosage": "0.5g",
        "frequency": "每日3次",
        "route": "口服",
        "duration": "7天",
        "notes": "餐后服用"
      }
    ],
    "dietary_guidance": "低脂饮食，少食多餐，避免油腻食物",
    "activity_guidance": "适度活动，避免剧烈运动和重体力劳动",
    "wound_care": "保持伤口干燥清洁，每3天换药一次，如发现红肿热痛及时就诊",
    "follow_up_plan": [
      {
        "item": "术后复查",
        "timing": "术后2周",
        "location": "普通外科门诊",
        "purpose": "伤口拆线、评估恢复情况"
      },
      {
        "item": "腹部B超",
        "timing": "术后1个月",
        "purpose": "评估腹腔情况"
      }
    ],
    "warnings": [
      "如出现发热、腹痛、黄疸等症状，请及时就医",
      "避免暴饮暴食和高脂饮食",
      "规律服药，不可自行停药"
    ]
  },
  "attending_physician": {
    "name": "张医生",
    "title": "主治医师"
  },
  "financial_info": {
    "total_cost": 18500.50,
    "insurance_coverage": 12000.00,
    "self_payment": 6500.50
  },
  "original_source": {
    "type": "image/text",
    "file_path": "images/出院小结.jpg",
    "created_at": "2024-08-15"
  },
  "notes": "其他补充信息或特殊说明"
}
```

### 3. 保存数据

- 如果是图片，复制到 `data/出院小结/YYYY-MM/images/`
- 创建月份目录（如不存在）
- 保存 JSON 数据文件
- 更新全局索引 `data/index.json`

### 4. 更新索引

在 `data/index.json` 中添加新记录：
```json
{
  "records": [
    {
      "id": "记录ID",
      "type": "出院小结",
      "admission_date": "YYYY-MM-DD",
      "discharge_date": "YYYY-MM-DD",
      "main_diagnosis": "主要诊断",
      "file_path": "出院小结/YYYY-MM/YYYY-MM-DD_主要诊断.json"
    }
  ]
}
```

### 5. 报告结果

```
✅ 出院小结已保存

住院信息：
━━━━━━━━━━━━━━━━━━━━━━━━━━
医院：某某医院
科室：消化内科
入院日期：2024-08-10
出院日期：2024-08-15
住院天数：5天

主要诊断：
━━━━━━━━━━━━━━━━━━━━━━━━━━
入院诊断：急性胆囊炎
出院诊断：急性胆囊炎

主要治疗：
━━━━━━━━━━━━━━━━━━━━━━━━━━
- 腹腔镜下胆囊切除术（2024-08-12）
- 抗感染治疗
- 解痉止痛治疗

出院医嘱：
━━━━━━━━━━━━━━━━━━━━━━━━━━
用药：阿莫西林胶囊 0.5g 每日3次 × 7天
饮食：低脂饮食，少食多餐
复查：术后2周门诊复查

数据已保存至：
data/出院小结/2024-08/2024-08-15_急性胆囊炎.json
```

## 智能提取规则

### 诊断信息提取

- **主要诊断**：通常排在第一位的诊断
- **次要诊断**：合并症、并发症
- **ICD-10编码**：如有，自动提取

### 手术信息提取

- 识别"手术名称"、"手术日期"、"麻醉方式"
- 自动关联到手术记录（如果已存在）

### 药物信息提取

从出院医嘱中提取：
- 药品名称（通用名）
- 剂量（如 0.5g、10mg）
- 用法（每日3次、必要时）
- 给药途径（口服、静脉滴注）
- 疗程（7天、遵医嘱）

### 复查计划提取

识别：
- 复查时间点（如"术后2周"、"1个月后"）
- 复查项目（如"血常规"、"B超"）
- 复查地点（如"门诊"、"某某科室"）

## 使用示例

### 从图片提取：

```bash
# 自动提取日期
/discharge @医疗报告/出院小结.jpg

# 手动指定日期
/discharge @医疗报告/出院小结.jpg 2024-08-10 2024-08-15
```

### 从文字描述：

```bash
# 直接粘贴出院小结内容
/discharge 我因急性胆囊炎于8月10日住院，8月15日出院，做了腹腔镜手术，医生让我低脂饮食，2周后复查

# 简单描述
/discharge 2024年8月因肺炎住院5天，出院后要继续吃抗生素3天，一周后复查胸片
```

## 扩展功能

### 自动关联

- 如果出院小结中提到手术，自动关联或创建对应的手术记录
- 如果有检验检查异常，自动关联到检查记录

### 数据验证

- 验证日期逻辑（出院日期不能早于入院日期）
- 验证药物剂量合理性
- 检查必填字段完整性

### 提醒功能

- 根据出院医嘱，提醒复查时间
- 提醒用药完成情况
- 提醒注意事项

## 注意事项

- 如果图片模糊或无法识别某些内容，尽最大努力提取可识别的信息
- 关键信息（诊断、治疗、医嘱）必须准确提取
- 如果无法识别，询问用户补充
- 药物信息尽可能完整，包括通用名和剂量
- 复查计划要准确提取时间节点
- 所有日期统一使用 YYYY-MM-DD 格式
- 保持原文准确性，不要自行添加内容

## 数据查询

出院小结可以通过 `/query discharge` 命令查询：
- 查询所有出院记录
- 按时间范围查询
- 按诊断查询
- 按医院查询
- 按科室查询

## 特殊场景处理

### 多次住院

同一疾病多次住院，每次出院小结都单独保存，通过关联字段链接

### 转科记录

如果住院期间有转科，记录所有科室和对应时间

### 危重抢救

特别标记抢救记录和抢救时间

### 死亡病例

如果患者死亡，特别标注并记录死亡原因和时间
