---
description: 管理过敏史记录
arguments:
  - name: action
    description: 操作类型：add(添加)/list(列出)/update(更新)/delete(删除)
    required: true
  - name: info
    description: 过敏信息（过敏原、严重程度、反应症状等，自然语言描述）
    required: false
---

# 过敏史管理

记录和管理过敏史，包括药物过敏、食物过敏、环境过敏等，支持快速查询和更新。

## 操作类型

### 1. 添加过敏记录 - `add`

添加新的过敏记录。

**参数说明：**
- `info`: 过敏信息（必填），使用自然语言描述

**示例：**
```
/allergy add 青霉素严重过敏小时候打针后出现呼吸困难
/allergy add 花生中度过敏吃后嘴唇肿
/allergy add 花粉轻度打喷嚏流鼻涕
/allergy add 碘造影剂严重CT检查时出现过休克
/allergy add 蜜蜂叮咬过敏性休克全身起疹子喉头水肿
```

**支持的描述格式：**
- 过敏原名称 + 严重程度 + 反应症状 + 发现情况
- 过敏原名称可以是：药物名称、食物名称、环境因素等
- 严重程度关键词：轻微、轻度、中度、严重、休克、过敏性休克
- 反应症状：皮疹、呼吸困难、喉头水肿、恶心、呕吐等

### 2. 查看过敏记录 - `list`

查看所有过敏记录，支持筛选。

**参数说明：**
- 无参数：显示所有过敏
- `active`: 仅显示活跃的过敏
- `drug`: 仅显示药物过敏
- `food`: 仅显示食物过敏
- `severe`: 仅显示严重程度为重度及以上的过敏

**示例：**
```
/allergy list
/allergy list active
/allergy list drug
/allergy list severe
```

### 3. 更新过敏记录 - `update`

更新已有的过敏记录。

**参数说明：**
- `info`: 更新信息（必填），格式：过敏原名称 + 要更新的字段和值

**示例：**
```
/allergy update 青霉素 severity moderate
/allergy update 花生 status resolved
/allergy update 青霉素 notes 仍需避免使用
/allergy update 花生
```

**支持的字段：**
- `severity`: 严重程度（mild/moderate/severe/anaphylaxis）
- `status`: 当前状态（active/resolved）
- `notes`: 备注信息

### 4. 删除过敏记录 - `delete`

删除过敏记录。

**参数说明：**
- `info`: 过敏原名称（必填）

**示例：**
```
/allergy delete 青霉素
/allergy delete 花生
```

## 执行步骤

### 添加过敏记录 (add)

#### 1. 解析过敏信息

从自然语言中提取：

**基本信息（自动提取）：**
- **过敏原名称**：具体过敏的物质名称
- **过敏类型**：药物、食物、环境、其他
- **严重程度**：轻度、中度、重度、过敏性休克
- **反应症状**：具体的过敏反应表现

**详细信息（提取或询问）：**
- **发现时间**：何时首次发现过敏
- **发现情况**：当时的情况和背景
- **确认方式**：医生诊断、自我观察、检测确认
- **当前状态**：仍然过敏或已缓解

#### 2. 医学标准化转换

将通俗描述转换为标准医学术语：

| 通俗描述 | 医学术语 | 类型 |
|---------|---------|------|
| 青霉素、盘尼西林 | 青霉素 | 药物过敏 |
| 花生、坚果 | 花生 | 食物过敏 |
| 花粉、柳絮 | 花粉 | 环境过敏 |
| 碘造影剂、CT造影剂 | 碘造影剂 | 药物过敏 |
| 蜜蜂叮咬、黄蜂叮咬 | 膜翅目昆虫毒液 | 其他过敏 |

#### 3. 过敏类型分类

按类别分类：

- **药物过敏**：抗生素（青霉素、头孢等）、止痛药（阿司匹林等）、造影剂、疫苗、中药等
- **食物过敏**：海鲜（虾、蟹、贝类）、坚果（花生、核桃）、蛋类、乳制品、麸质、水果等
- **环境过敏**：花粉、尘螨、动物毛发、霉菌、乳胶等
- **其他过敏**：昆虫叮咬、化学物质、金属等

#### 4. 严重程度评估

**轻度（1级）：**
- 局部皮肤反应（轻微皮疹、瘙痒）
- 不影响全身状态
- 无需紧急处理

**中度（2级）：**
- 明显不适（明显皮疹、恶心、轻度呼吸困难）
- 需要处理但无生命危险
- 建议就医

**重度（3级）：**
- 严重反应（严重呼吸困难、全身性荨麻疹、血压下降）
- 需要医疗干预
- 必须就医

**过敏性休克（4级）：**
- 危及生命的全身性过敏反应
- 休克、喉头水肿、意识丧失
- 需要紧急抢救

#### 5. 严重程度自动判断

**关键词映射：**
- "休克"、"过敏性休克"、"意识丧失"、"昏迷" → 4级（过敏性休克）
- "严重"、"全身性"、"无法忍受"、"血压下降" → 3级（重度）
- "明显"、"中度"、"需要处理"、"肿胀" → 2级（中度）
- "轻微"、"轻度"、"偶尔"、"局部" → 1级（轻度）

#### 6. 反应症状识别

**皮肤症状：**
- 皮疹、荨麻疹、瘙痒、红肿、红斑

**呼吸系统症状：**
- 呼吸困难、喘息、喉头水肿、胸闷

**消化系统症状：**
- 恶心、呕吐、腹泻、腹痛

**全身症状：**
- 休克、血压下降、昏厥、意识丧失、全身性荨麻疹

#### 7. 保存过敏记录

**文件路径格式：**
`data/allergies.json`

**JSON 数据结构：**
```json
{
  "allergies": [
    {
      "id": "allergy_20251231123456789",
      "allergen": {
        "name": "青霉素",
        "type": "drug",
        "type_category": "药物过敏",
        "synonyms": ["Penicillin", "盘尼西林"]
      },
      "severity": {
        "level": "severe",
        "level_code": 3,
        "description": "严重过敏反应"
      },
      "reactions": [
        {
          "reaction": "皮疹",
          "onset_time": "接触后30分钟内",
          "severity": "中度"
        },
        {
          "reaction": "呼吸困难",
          "onset_time": "接触后15分钟",
          "severity": "重度"
        }
      ],
      "discovery": {
        "date": "2010-05-15",
        "age_at_discovery": "8岁",
        "circumstances": "肺炎治疗期间注射青霉素后出现"
      },
      "confirmation": {
        "method": "doctor_confirmed",
        "method_name": "医生诊断",
        "confirmed_by": "XX医院儿科",
        "test_results": null
      },
      "current_status": {
        "status": "active",
        "status_name": "活跃",
        "last_occurrence": "2020-03-10",
        "resolved_date": null
      },
      "management": {
        "avoidance_strategy": "严格避免使用青霉素类药物",
        "emergency_plan": "如误用，立即就医，携带过敏信息",
        "carries_epipen": false,
        "medical_alert": true
      },
      "notes": "所有就诊时必须主动告知医护人员",
      "metadata": {
        "created_at": "2025-12-31T12:34:56.789Z",
        "last_updated": "2025-12-31T12:34:56.789Z"
      }
    }
  ],
  "statistics": {
    "total_allergies": 5,
    "active_allergies": 4,
    "drug_allergies": 2,
    "food_allergies": 1,
    "environmental_allergies": 1,
    "other_allergies": 1,
    "severe_count": 2,
    "anaphylaxis_count": 1,
    "last_updated": "2025-12-31T12:34:56.789Z"
  }
}
```

#### 8. 输出确认

```
✅ 过敏记录已添加

过敏原信息：
━━━━━━━━━━━━━━━━━━━━━━━━━━
过敏原：青霉素
类型：药物过敏
严重程度：🔴 严重（3级）

过敏反应：
━━━━━━━━━━━━━━━━━━━━━━━━━━
• 皮疹 - 中度，接触后30分钟内
• 呼吸困难 - 重度，接触后15分钟

发现情况：
━━━━━━━━━━━━━━━━━━━━━━━━━━
发现时间：2010-05-15（8岁）
确认方式：医生诊断
当时情况：肺炎治疗期间注射后出现

管理建议：
━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️ 所有就诊必须告知医护人员
🚫 严格避免使用青霉素类药物
🆔 建议佩戴医疗警示标识

数据已保存至：data/allergies.json
```

### 查看过敏记录 (list)

**输出格式：**
```
📋 过敏史清单

━━━━━━━━━━━━━━━━━━━━━━━━━━
共 5 条过敏记录（4 条活跃）

药物过敏（2）：
━━━━━━━━━━━━━━━━━━━━━━━━━━

1. 青霉素 🔴 严重
   ━━━━━━━━━━━━━━━━━━━━━━━━━━
   反应：皮疹、呼吸困难
   发现：2010-05-15（医生诊断）
   状态：活跃 ⚠️

2. 碘造影剂 🟠 重度
   ━━━━━━━━━━━━━━━━━━━━━━━━━━
   反应：全身荨麻疹、血压下降
   发现：2018-03-20（医生诊断）
   状态：活跃 ⚠️

食物过敏（1）：
━━━━━━━━━━━━━━━━━━━━━━━━━━

3. 花生 🟡 中度
   ━━━━━━━━━━━━━━━━━━━━━━━━━━
   反应：嘴唇肿胀、恶心
   发现：2015-08-10（自我观察）
   状态：活跃 ⚠️

环境过敏（1）：
━━━━━━━━━━━━━━━━━━━━━━━━━━

4. 花粉 🟢 轻度
   ━━━━━━━━━━━━━━━━━━━━━━━━━━
   反应：打喷嚏、流鼻涕、眼痒
   发现：2019-03-01（检测确认）
   状态：活跃

其他过敏（1）：
━━━━━━━━━━━━━━━━━━━━━━━━━━

5. 蜜蜂叮咬 🔴 过敏性休克
   ━━━━━━━━━━━━━━━━━━━━━━━━━━
   反应：全身性荨麻疹、喉头水肿、意识丧失
   发现：2012-07-22（医生诊断）
   状态：活跃 🆘 携带肾上腺素笔

━━━━━━━━━━━━━━━━━━━━━━━━━━
图例：🟢轻度 🟡中度 🟠重度 🔴严重 🆘休克

重要提醒：
━━━━━━━━━━━━━━━━━━━━━━━━━━
• 有 2 条严重过敏记录，就诊时必须主动告知
• 有 1 条过敏性休克记录，需随身携带急救药物
```

**筛选输出示例：**

仅药物过敏：
```
📋 药物过敏清单

━━━━━━━━━━━━━━━━━━━━━━━━━━
共 2 条药物过敏记录

1. 青霉素 🔴 严重
   ━━━━━━━━━━━━━━━━━━━━━━━━━━
   反应：皮疹、呼吸困难
   发现：2010-05-15

2. 碘造影剂 🟠 重度
   ━━━━━━━━━━━━━━━━━━━━━━━━━━
   反应：全身荨麻疹、血压下降
   发现：2018-03-20
```

仅严重过敏：
```
📋 严重过敏清单

━━━━━━━━━━━━━━━━━━━━━━━━━━
共 3 条严重过敏记录

⚠️ 以下过敏可能危及生命，就诊时必须主动告知：

1. 青霉素 🔴 严重
2. 碘造影剂 🟠 重度
3. 蜜蜂叮咬 🆘 过敏性休克
```

### 更新过敏记录 (update)

#### 1. 查找过敏记录

根据过敏原名称查找已有记录。

#### 2. 识别更新字段

**支持的字段：**
- `severity`: 严重程度（mild/moderate/severe/anaphylaxis）
- `status`: 当前状态（active/resolved）
- `notes`: 备注信息

#### 3. 交互式更新

如果只提供过敏原名称，进入交互式更新模式：
```
📝 更新过敏记录：青霉素

当前信息：
━━━━━━━━━━━━━━━━━━━━━━━━━━
严重程度：严重（3级）
状态：活跃

选择要更新的字段：
━━━━━━━━━━━━━━━━━━━━━━━━━━
1. 严重程度
2. 当前状态
3. 反应症状
4. 管理策略
5. 备注

请输入选项编号（1-5）：
```

#### 4. 输出确认

```
✅ 过敏记录已更新

过敏原：青霉素
更新字段：严重程度
原值：严重（3级）
新值：中度（2级）

更新时间：2025-12-31 12:34
```

### 删除过敏记录 (delete)

#### 1. 查找过敏记录

根据过敏原名称查找要删除的记录。

#### 2. 显示确认信息

```
⚠️ 确认删除

即将删除过敏记录：
━━━━━━━━━━━━━━━━━━━━━━━━━━
过敏原：青霉素
严重程度：严重（3级）
发现时间：2010-05-15

删除后无法恢复，是否确认？

A. 确认删除
B. 取消
```

#### 3. 执行删除

用户确认后删除记录，更新统计数据。

#### 4. 输出确认

```
✅ 过敏记录已删除

过敏原：青霉素
删除时间：2025-12-31 12:34
```

## 智能识别规则

### 过敏原名称识别

**常见药物过敏原：**
- 抗生素：青霉素、头孢、红霉素、阿莫西林、氨苄西林等
- 止痛药：阿司匹林、布洛芬、双氯芬酸钠等
- 造影剂：碘造影剂、钆造影剂等
- 疫苗：流感疫苗、乙肝疫苗等

**常见食物过敏原：**
- 海鲜：虾、蟹、贝类、鲍鱼等
- 坚果：花生、核桃、杏仁、腰果等
- 其他：蛋、牛奶、芝麻、芒果、菠萝等

**常见环境过敏原：**
- 花粉：花粉、柳絮、梧桐絮等
- 动物：猫毛、狗毛、羽毛等
- 其他：尘螨、霉菌、乳胶等

### 严重程度识别

| 关键词 | 严重程度 | 级别 |
|--------|---------|------|
| 休克、过敏性休克、意识丧失、昏迷 | 过敏性休克 | 4 |
| 严重、全身性、血压下降、无法忍受 | 重度 | 3 |
| 明显、中度、肿胀、需要处理 | 中度 | 2 |
| 轻微、轻度、局部、偶尔 | 轻度 | 1 |

### 反应症状识别

**皮肤症状：**
皮疹、荨麻疹、瘙痒、红肿、红斑、肿胀

**呼吸症状：**
呼吸困难、喘息、喉头水肿、胸闷、气短

**消化症状：**
恶心、呕吐、腹泻、腹痛、腹胀

**全身症状：**
休克、血压下降、昏厥、意识丧失、全身性反应

### 确认方式识别

**医生诊断：**
医生诊断、医院诊断、医生确认

**自我观察：**
自己发现、自我观察、遇到过

**检测确认：**
皮试、血检、过敏原检测、检测确认

## 数据结构更新

在全局索引 `data/index.json` 中添加：

```json
{
  "allergy_records": "data/allergies.json",
  "statistics": {
    "allergy_count": 5
  }
}
```

## 与药物命令的集成

当使用 `/medication add` 添加药物时，系统会自动检查过敏记录：

**检查逻辑：**
1. 解析药物名称，提取通用名和药物类别
2. 检查 `data/allergies.json` 中是否存在相关过敏
3. 对于药物过敏，检查药物家族关系：
   - 青霉素类：青霉素、阿莫西林、氨苄西林、美洛西林等
   - 头孢类：头孢唑林、头孢克肟、头孢曲松等
   - 磺胺类：磺胺甲噁唑、磺胺嘧啶等
4. 如果发现潜在过敏，显示警示信息

**警示输出：**
```
⚠️ 过敏警示

检测到您可能对以下药物过敏：

• 青霉素 - 严重过敏
  添加的药物：阿莫西林（属于青霉素类）

建议：
━━━━━━━━━━━━━━━━━━━━━━━━━━
1. 如确认不过敏，可继续添加
2. 如不确定，建议咨询医生或药师
3. 请仔细核对药物成分

是否继续添加？
A. 继续添加
B. 取消
```

## 与就诊准备命令的集成

当使用 `/prepare` 命令时，会自动显示过敏信息：

**输出示例：**
```
您的健康摘要：
━━━━━━━━━━━━━━━━━━━━━━━━━━

过敏史重点提示（3条）：
━━━━━━━━━━━━━━━━━━━━━━━━━━
🔴 青霉素 - 严重过敏（必须告知）
🔴 碘造影剂 - 严重过敏（检查时提醒）
🆘 蜜蜂叮咬 - 过敏性休克（携带急救药）

就诊准备清单：
━━━━━━━━━━━━━━━━━━━━━━━━━━
☐ 身份证/医保卡（必带）
☐ 过敏史清单（必带）⭐
☐ 用药清单或正在服用的药物
☐ 过敏急救药物（如携带）⭐
☐ 既往检查报告
```

## 注意事项

- 本系统仅供过敏记录，不能替代专业医疗诊断
- 严重过敏和过敏性休克患者，应随身携带急救药物和医疗警示标识
- 所有就诊时必须主动告知医护人员过敏史
- 定期更新过敏记录，记录新的过敏或已缓解的过敏
- 所有数据仅保存在本地

## 示例用法

```
# 添加严重药物过敏
/allergy add 青霉素严重过敏小时候打针后出现呼吸困难

# 添加过敏性休克
/allergy add 蜜蜂叮咬过敏性休克全身起疹子喉头水肿意识丧失

# 添加食物过敏
/allergy add 花生中度过敏吃后嘴唇肿恶心

# 添加环境过敏
/allergy add 花粉轻度打喷嚏流鼻涕眼痒

# 列出所有过敏
/allergy list

# 仅列出药物过敏
/allergy list drug

# 仅列出严重过敏
/allergy list severe

# 更新严重程度
/allergy update 青霉素 severity moderate

# 标记为已缓解
/allergy update 花生 status resolved

# 删除过敏记录
/allergy delete 花生
```

## 错误处理

- **过敏信息为空**: "请提供过敏信息，例如：/allergy add 青霉素严重过敏"
- **过敏原已存在**: "该过敏原已存在，请使用 /allergy update 更新记录"
- **过敏原不存在**: "未找到该过敏原记录"
- **无法识别严重程度**: "无法识别严重程度，请明确说明（轻度/中度/重度/过敏性休克）"
- **无法识别过敏类型**: "无法识别过敏类型，请提供更详细的信息"
- **无过敏记录**: "暂无过敏记录"
- **删除取消**: "已取消删除"
- **存储失败**: "保存记录失败，请检查存储空间"
